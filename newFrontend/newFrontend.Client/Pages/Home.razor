@page "/"
@using newFrontend.Client.Models
@using newFrontend.Client.Services
@inject IDialogService DialogService
@inject IParkingService ParkingService
@inject ISnackbar Snackbar

<PageTitle>Visão Geral - T&D</PageTitle>

<br />
<MudText Typo="Typo.h4" GutterBottom="true">Visão Geral</MudText>

<MudText Typo="Typo.subtitle1">Nesta página, você tem uma visão geral dos veículos estacionados TIVIT & Dio Parking.
</MudText>
<br />

<MudTable Items="@veiculos" FixedHeader="@fixed_header" FixedFooter="@fixed_footer"
  Height="@(fixed_header || fixed_footer ? "300px" : "")" Hover="true" Breakpoint="Breakpoint.Sm"
  Filter="@(veiculo => FilterFunc(veiculo, searchString1))" Loading="@loading" LoadingProgressColor="Color.Info">
  <ToolBarContent>
    <MudText Typo="Typo.h6">Veículos Estacionados</MudText>
    <MudSpacer />
    <MudTextField @bind-Value="searchString1" Placeholder="Pesquisa por placa" Adornment="Adornment.Start"
      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
  </ToolBarContent>
  <HeaderContent>
    <MudTh>
      <MudTableSortLabel SortBy="@((Veiculo veiculo) => veiculo.Placa)">
        Placa
      </MudTableSortLabel>
    </MudTh>
    <MudTh>
      <MudTableSortLabel SortBy="@((Veiculo veiculo) => veiculo.Type)">
        Tipo
      </MudTableSortLabel>
    </MudTh>
    <MudTh>
      <MudTableSortLabel SortBy="@((Veiculo veiculo) => veiculo.EntryTime)">
        Entrada
      </MudTableSortLabel>
    </MudTh>
    <MudTh>Valor Estimado</MudTh>
    <MudTh>Ações</MudTh>
  </HeaderContent>
  <RowTemplate>
    <MudTd DataLabel="Placa">
      <MudChip T="string" Label="true">@context.Placa</MudChip>
    </MudTd>
    <MudTd DataLabel="Tipo">@FormatType(context.Type)</MudTd>
    <MudTd DataLabel="Entrada">@context.EntryTime.ToString("t")</MudTd>
    <MudTd DataLabel="Valor">@context.TicketPrice?.ToString("C")</MudTd>
    <MudTd DataLabel="Ações">
      <MudIconButton Icon="@Icons.Material.Filled.CarRental" Color="Color.Success" title="Fazer Checkout"
        OnClick="@(() => MakeCheckout(context))" />
    </MudTd>
  </RowTemplate>
  <PagerContent>
    <MudTablePager />
  </PagerContent>
</MudTable>

@code {
  private List<Veiculo> veiculos = new();
  private bool loading = true;
  private string searchString1 = "";
  bool fixed_header = true;
  bool fixed_footer = false;

  protected override async Task OnInitializedAsync()
  {
    try
    {
      veiculos = await ParkingService.GetVeiculosAsync();
    }
    catch (Exception ex)
    {
      Console.WriteLine($"Erro: {ex.Message}");
    }
    finally
    {
      loading = false;
    }
  }

  private string FormatType(VehicleType tipo)
  {
    if (tipo == VehicleType.Motorcycle)
      return "Moto";

    return "Carro";
  }

  private bool FilterFunc(Veiculo veiculo, string searchString)
  {
    if (string.IsNullOrWhiteSpace(searchString))
      return true;
    if (veiculo.Placa.Contains(searchString, StringComparison.OrdinalIgnoreCase))
      return true;
    return false;
  }

  private async Task MakeCheckout(Veiculo veiculo)
  {
    var parameters = new DialogParameters { ["VehicleId"] = veiculo.Id };

    var dialogReference = await DialogService.ShowAsync<CheckoutDialog>("Realizar Checkout", parameters);
    var result = await dialogReference.Result;

    if (result is not null)
    {
      if (!result.Canceled)
      {
        if (result.Data is DateTime previewDate)
        {
          var response = await ParkingService.MakeCheckoutAsync(veiculo.Id, previewDate);
          if (response.IsSuccessStatusCode)
          {
            Snackbar.Add($"Checkout de {veiculo.Placa} realizado!", Severity.Success);
            veiculos = await ParkingService.GetVeiculosAsync();
          }
          else
          {
            Snackbar.Add("Erro ao realizar checkout.", Severity.Error);
          }
        }
      }
    }
  }
}
